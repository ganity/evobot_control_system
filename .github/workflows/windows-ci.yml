name: Windows CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  test-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements-windows.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install system dependencies
      run: |
        # å®‰è£…Windowsç‰¹å®šçš„ç³»ç»Ÿä¾èµ–
        choco install --no-progress -y vcredist2019
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        # ä½¿ç”¨Windowså…¼å®¹çš„ä¾èµ–æ–‡ä»¶
        pip install -r requirements-windows.txt
        # å®‰è£…æµ‹è¯•ä¾èµ–
        pip install pytest pytest-cov pytest-qt pytest-xvfb
    
    - name: Verify PyQt5 installation
      run: |
        python -c "from PyQt5.QtWidgets import QApplication; print('PyQt5 OK')"
        python -c "import pyqtgraph; print('PyQtGraph OK')"
        python -c "import serial; print('PySerial OK')"
    
    - name: Run dependency tests
      run: |
        python test_deps.py
    
    - name: Run unit tests
      run: |
        # è®¾ç½®è™šæ‹Ÿæ˜¾ç¤ºç¯å¢ƒå˜é‡
        $env:QT_QPA_PLATFORM = "offscreen"
        # è¿è¡Œæµ‹è¯•
        python -m pytest tests/ -v --tb=short --cov=src --cov-report=xml
      continue-on-error: true  # GUIæµ‹è¯•å¯èƒ½åœ¨CIç¯å¢ƒä¸­å¤±è´¥
    
    - name: Test application startup
      run: |
        # æµ‹è¯•åº”ç”¨ç¨‹åºèƒ½å¦æ­£å¸¸å¯åŠ¨ï¼ˆæ— GUIæ¨¡å¼ï¼‰
        $env:QT_QPA_PLATFORM = "offscreen"
        timeout 30 python -c "
        import sys
        sys.path.insert(0, 'src')
        from startup_optimizer import setup_fast_startup
        setup_fast_startup()
        print('Startup test passed')
        "
      continue-on-error: true
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: windows
        name: codecov-windows
      if: matrix.python-version == '3.11'  # åªåœ¨ä¸€ä¸ªç‰ˆæœ¬ä¸Šä¼ è¦†ç›–ç‡

  build-windows:
    runs-on: windows-latest
    needs: test-windows
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-windows.txt
        pip install -r build_requirements.txt
    
    - name: Build executable
      run: |
        # è¿è¡Œæ‰“åŒ…è„šæœ¬
        .\build_windows.bat
    
    - name: Test executable
      run: |
        # æµ‹è¯•ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶
        if (Test-Path "dist\EvoBotæ§åˆ¶ç³»ç»Ÿ\EvoBotæ§åˆ¶ç³»ç»Ÿ.exe") {
          Write-Host "âœ… å¯æ‰§è¡Œæ–‡ä»¶ç”ŸæˆæˆåŠŸ"
          # å¯ä»¥æ·»åŠ æ›´å¤šæµ‹è¯•ï¼Œæ¯”å¦‚æ£€æŸ¥æ–‡ä»¶å¤§å°ç­‰
          $size = (Get-Item "dist\EvoBotæ§åˆ¶ç³»ç»Ÿ\EvoBotæ§åˆ¶ç³»ç»Ÿ.exe").Length / 1MB
          Write-Host "ğŸ“¦ å¯æ‰§è¡Œæ–‡ä»¶å¤§å°: $([math]::Round($size, 2)) MB"
        } else {
          Write-Host "âŒ å¯æ‰§è¡Œæ–‡ä»¶ç”Ÿæˆå¤±è´¥"
          exit 1
        }
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: evobot-windows-build
        path: |
          dist/EvoBotæ§åˆ¶ç³»ç»Ÿ/
          !dist/EvoBotæ§åˆ¶ç³»ç»Ÿ/**/*.pdb
        retention-days: 30
    
    - name: Create release archive
      run: |
        # åˆ›å»ºå‘å¸ƒå‹ç¼©åŒ…
        Compress-Archive -Path "dist\EvoBotæ§åˆ¶ç³»ç»Ÿ\*" -DestinationPath "EvoBot-Windows-x64.zip"
    
    - name: Upload release archive
      uses: actions/upload-artifact@v3
      with:
        name: evobot-windows-release
        path: EvoBot-Windows-x64.zip
        retention-days: 90

  code-quality:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install code quality tools
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 mypy
        pip install -r requirements-windows.txt
    
    - name: Run Black formatter check
      run: |
        black --check --diff src/ tests/
      continue-on-error: true
    
    - name: Run Flake8 linter
      run: |
        flake8 src/ tests/ --max-line-length=88 --extend-ignore=E203,W503
      continue-on-error: true
    
    - name: Run MyPy type checker
      run: |
        mypy src/ --ignore-missing-imports
      continue-on-error: true