name: Windows CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-windows.txt
        pip install pyinstaller
    
    - name: Build executable
      run: |
        # è¿è¡Œæ‰“åŒ…è„šæœ¬
        pyinstaller evobot.spec --clean --noconfirm
    
    - name: Test executable
      run: |
        # æµ‹è¯•ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶
        if (Test-Path "dist\EvoBotæ§åˆ¶ç³»ç»Ÿ\EvoBotæ§åˆ¶ç³»ç»Ÿ.exe") {
          Write-Host "âœ… å¯æ‰§è¡Œæ–‡ä»¶ç”ŸæˆæˆåŠŸ"
          # å¯ä»¥æ·»åŠ æ›´å¤šæµ‹è¯•ï¼Œæ¯”å¦‚æ£€æŸ¥æ–‡ä»¶å¤§å°ç­‰
          $size = (Get-Item "dist\EvoBotæ§åˆ¶ç³»ç»Ÿ\EvoBotæ§åˆ¶ç³»ç»Ÿ.exe").Length / 1MB
          Write-Host "ğŸ“¦ å¯æ‰§è¡Œæ–‡ä»¶å¤§å°: $([math]::Round($size, 2)) MB"
        } else {
          Write-Host "âŒ å¯æ‰§è¡Œæ–‡ä»¶ç”Ÿæˆå¤±è´¥"
          exit 1
        }
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: evobot-windows-build
        path: |
          dist/EvoBotæ§åˆ¶ç³»ç»Ÿ/
          !dist/EvoBotæ§åˆ¶ç³»ç»Ÿ/**/*.pdb
        retention-days: 30
    
    - name: Create release archive
      run: |
        # åˆ›å»ºå‘å¸ƒå‹ç¼©åŒ…
        Compress-Archive -Path "dist\EvoBotæ§åˆ¶ç³»ç»Ÿ\*" -DestinationPath "EvoBot-Windows-x64.zip"
    
    - name: Upload release archive
      uses: actions/upload-artifact@v4
      with:
        name: evobot-windows-release
        path: EvoBot-Windows-x64.zip
        retention-days: 90

  code-quality:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install code quality tools
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 mypy
        pip install -r requirements-windows.txt
    
    - name: Run Black formatter check
      run: |
        black --check --diff src/ tests/
      continue-on-error: true
    
    - name: Run Flake8 linter
      run: |
        flake8 src/ tests/ --max-line-length=88 --extend-ignore=E203,W503
      continue-on-error: true
    
    - name: Run MyPy type checker
      run: |
        mypy src/ --ignore-missing-imports
      continue-on-error: true