name: Simple Windows Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        
        # ç›´æ¥å®‰è£…å…¼å®¹çš„PyQt5ç‰ˆæœ¬
        pip install PyQt5==5.15.10
        pip install PyQt5-sip==12.13.0
        
        # å®‰è£…å…¶ä»–ä¾èµ–
        pip install pyqtgraph pyserial numpy scipy pyyaml loguru matplotlib
        
        # å°è¯•å®‰è£…å¯é€‰ä¾èµ–
        pip install roboticstoolbox-python spatialmath-python || echo "å¯é€‰ä¾èµ–å®‰è£…å¤±è´¥ï¼Œç»§ç»­..."
    
    - name: Test imports
      run: |
        python -c "
        print('ğŸ§ª æµ‹è¯•ä¾èµ–å¯¼å…¥...')
        
        # æµ‹è¯•PyQt5
        from PyQt5.QtWidgets import QApplication
        print('âœ… PyQt5 å¯¼å…¥æˆåŠŸ')
        
        # æµ‹è¯•å…¶ä»–æ ¸å¿ƒä¾èµ–
        import pyqtgraph
        print('âœ… PyQtGraph å¯¼å…¥æˆåŠŸ')
        
        import serial
        print('âœ… PySerial å¯¼å…¥æˆåŠŸ')
        
        import numpy, scipy
        print('âœ… NumPy/SciPy å¯¼å…¥æˆåŠŸ')
        
        import yaml, loguru
        print('âœ… YAML/Loguru å¯¼å…¥æˆåŠŸ')
        
        print('ğŸ‰ æ‰€æœ‰æ ¸å¿ƒä¾èµ–æµ‹è¯•é€šè¿‡ï¼')
        "
    
    - name: Test application
      run: |
        python -c "
        import sys
        sys.path.insert(0, 'src')
        
        # æµ‹è¯•å¯åŠ¨ä¼˜åŒ–å™¨
        from startup_optimizer import setup_fast_startup
        setup_fast_startup()
        print('âœ… å¯åŠ¨ä¼˜åŒ–å™¨æµ‹è¯•é€šè¿‡')
        
        # æµ‹è¯•æ ¸å¿ƒæ¨¡å—å¯¼å…¥
        from utils.config_manager import ConfigManager
        print('âœ… é…ç½®ç®¡ç†å™¨å¯¼å…¥æˆåŠŸ')
        
        from utils.logger import get_logger
        print('âœ… æ—¥å¿—ç³»ç»Ÿå¯¼å…¥æˆåŠŸ')
        
        print('ğŸ‰ åº”ç”¨ç¨‹åºæ ¸å¿ƒæ¨¡å—æµ‹è¯•é€šè¿‡ï¼')
        "
    
    - name: Build executable (if push to main)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        # å®‰è£…PyInstaller
        pip install pyinstaller
        
        # æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
        pyinstaller evobot.spec --clean --noconfirm
        
        # æ£€æŸ¥æ„å»ºç»“æœ
        if (Test-Path "dist\EvoBotæ§åˆ¶ç³»ç»Ÿ\EvoBotæ§åˆ¶ç³»ç»Ÿ.exe") {
          Write-Host "âœ… æ„å»ºæˆåŠŸ"
          $size = (Get-Item "dist\EvoBotæ§åˆ¶ç³»ç»Ÿ\EvoBotæ§åˆ¶ç³»ç»Ÿ.exe").Length / 1MB
          Write-Host "ğŸ“¦ æ–‡ä»¶å¤§å°: $([math]::Round($size, 2)) MB"
        } else {
          Write-Host "âŒ æ„å»ºå¤±è´¥"
          Write-Host "ğŸ“ distç›®å½•å†…å®¹:"
          Get-ChildItem dist -Recurse -ErrorAction SilentlyContinue | Format-Table Name, Length
          exit 1
        }
    
    - name: Upload build artifact
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v3
      with:
        name: EvoBot-Windows-Simple
        path: dist/EvoBotæ§åˆ¶ç³»ç»Ÿ/
        retention-days: 7